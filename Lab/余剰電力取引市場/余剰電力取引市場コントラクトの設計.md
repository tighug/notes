# 余剰電力市場コントラクトの開発

## `MarketStateMachine.sol`

市場のステート（状態）を管理する

Enum Types

- `Stages`：市場のステート
  - 0：**RegisteringBidders**：市場参加者の登録
  - 1：**AcceptingBids**：入札受け入れ期間
  - 2：**AcceptingAuction**：約定受け入れ期間
  - 3：**WaitingAuction**：約定結果待ち期間
  - 4：**Finished**：市場の終了

State Variables

| variable        | type     | visibility | description            |
| --------------- | -------- | ---------- | ---------------------- |
| `_creationTime` | `uint`   | `private`  | コントラクトの作成時間 |
| `_bidPeriod`    | `uint`   | `private`  | 入札期間               |
| `_stage`        | `Stages` | `private`  | 現在の市場のステート   |

Modifiers

| modifier                | description                                   |
| ----------------------- | --------------------------------------------- |
| `atStage(Stages stage)` | 現在の市場のステートが`stage`の時のみ実行可能 |
| `timedTransitions()`    | 時間に従いステートを移行する                  |

Functions

- `constructor(uint256 bidPeriod)`
  - コンストラクタ
  - visibility：`public`
  - return：`void`
  - params
    - `bidPeriod`：入札期間
- `creationTime()`
  - コントラクトの作成時間
  - visibility：`external view`
  - return：`uint`
- `bidPeriod()`
  - 入札期間
  - visibility：`external view`
  - return：`uint`
- `state()`
  - 現在の市場のステート
  - visibility：`external view`
  - return：`Stages`
- `_nextStage()`
  - 次のステートに移行
  - visibility：`internal`
  - return：`void`

## `ELEC.sol`

余剰電力を表すトークン

- 売り手にとってはペナルティ、買い手に取っては電力使用権
- 電力は分割可能で、互いに交換可能な為、Fungible Token である **ERC20** 規格に準拠する

## `ELECFactory.sol`

ELEC を発行する

## `ElectricityMarket.sol`

State Variables

| variable             | type              | visibility | description                                 |
| -------------------- | ----------------- | ---------- | ------------------------------------------- |
| `pendingWithdrawals` | `address => uint` | `private`  | アドレスと保留中の Ether の出金のマッピング |

Functions

- `constructor()`
  - コンストラクタ
  - visibility：`public`
  - return：`void`
- `regiterBuyer(address buyer, uint nodeNum)`
  - 買い手を登録する
  - visibility：`private atStage(0)`
  - return：`void`
  - params
    - `buyer`：買い手のアドレス
    - `nodeNum`：買い手のノード番号
- `registerSeller(address seller, uint nodeNum, uint surplus)`
  - 売り手を登録する
  - visibility：`private atStage(0)`
  - return：`void`
  - params
    - `seller`：売り手のアドレス
    - `nodeNum`：ノード番号
    - `surplus`：売り手の余剰電力量
- `orderBuy(uint price, uint amount)`
  - 買い入札を出す
  - visibility：`external payable`
  - return：`void`
  - params
    - `price`：入札価格
    - `amount`：入札量
- `orderSell(uint price)`
  - 買い入札を出す
  - visibility：`external`
  - return：`void`
  - params
    - `price`：入札価格
    - ※ 入札量は余剰電力量と同じ
- `withdraw()`
  - 取引で得た Ether を引き出す
  - visibility：`external`
  - return：`void`
- `_sendProvableQuery(uint timestamp)`
  - オラクルクエリを送る
  - visibility：`private atStage(0)`
  - return：`void`

## `ElectricityMarketFactory.sol`

State Variables

| variable   | type                  | visibility | description                           |
| ---------- | --------------------- | ---------- | ------------------------------------- |
| `_markets` | `ElectricityMarket[]` | `private`  | `ElectricityMarket`コントラクトの配列 |

Functions

- `constructor()`
  - コンストラクタ
  - visibility：`public`
  - return：`void`
- `openNewMarket(address owner, string memory name, uint bidPeriod)`
  - 市場を開く
  - return：`void`
  - params
    - `owner`：作成する市場の所有者
    - `name`：市場（= ELEC トークン）の名前
    - `bidPeriod`：入札期間

## `Ownable.sol`（OpenZeppelin）

コントラクトの所有者を管理する

- [OpenZeppelin Ownership](../../Blockchain/OpenZeppelin_Ownership.md)
