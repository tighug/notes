# 余剰電力市場コントラクトの開発

## `MarketStateMachine.sol`

市場のステート（状態）を管理する

Enum Types

- `Stages`：市場のステート
  - 0：**RegisteringBidders**：市場参加者の登録
  - 1：**AcceptingBids**：入札受け入れ期間
  - 2：**AcceptingAuction**：約定受け入れ期間
  - 3：**WaitingAuction**：約定結果待ち期間
  - 4：**Finished**：市場の終了

State Variables

| variable        | type     | visibility | description            |
| --------------- | -------- | ---------- | ---------------------- |
| `_creationTime` | `uint`   | `private`  | コントラクトの作成時間 |
| `_bidPeriod`    | `uint`   | `private`  | 入札期間               |
| `_stage`        | `Stages` | `private`  | 現在の市場のステート   |

Modifiers

| modifier                | description                                   |
| ----------------------- | --------------------------------------------- |
| `atStage(Stages stage)` | 現在の市場のステートが`stage`の時のみ実行可能 |
| `timedTransitions()`    | 時間に従いステートを移行する                  |

Functions

| function                         | return   | visibility      | description            |
| -------------------------------- | -------- | --------------- | ---------------------- |
| `constructor(uint256 bidPeriod)` | `void`   | `public`        | コンストラクタ         |
| `creationTime()`                 | `uint`   | `external view` | コントラクトの作成時間 |
| `bidPeriod()`                    | `uint`   | `external view` | 入札期間               |
| `state()`                        | `Stages` | `external view` | 現在の市場のステート   |
| `_nextStage()`                   | `void`   | `internal`      | 次のステートに移行     | ~~~~ |

## `ELEC.sol`

余剰電力を表すトークン

- 売り手にとってはペナルティ、買い手に取っては電力使用権
- 電力は分割可能で、互いに交換可能な為、Fungible Token である **ERC20** 規格に準拠する

## `ELECFactory.sol`

ELEC を発行する

## `ElectricityMarket.sol`

State Variables

| variable             | type              | visibility | description                                 |
| -------------------- | ----------------- | ---------- | ------------------------------------------- |
| `pendingWithdrawals` | `address => uint` | `private`  | アドレスと保留中の Ether の出金のマッピング |

Functions

| function                                                      | return | visibility           | description                                   |
| ------------------------------------------------------------- | ------ | -------------------- | --------------------------------------------- |
| `constructor()`                                               | `void` | `public`             | コンストラクタ                                |
| `regiterBuyer(address buyer, uint nodeNum)`                  | `void` | `private atStage(0)` | 買い手を登録する                              |
| `registerSeller(address seller, uint nodeNum, uint surplus)` | `void` | `private atStage(0)` | 売り手を登録する                              |
| `orderBuy(uint price, uint amount)`                           | `void` | `external payable`   | `amount`分の電力を買う希望を出す              |
| `orderSell(uint price)`                                       | `void` | `external`           | 余剰分の全ての電力を`price`円で売る希望を出す |
| `withdraw()`                                                  | `void` | `external`           | 取引後に得た Ether を引き出す                 |

| `_sendProvableQuery(uint timestamp)`                          | `void` | `private atStage(0)` | オラクルクエリを送る                          |

## `ElectricityMarketFactory.sol`

State Variables

| variable   | type                  | visibility | description                           |
| ---------- | --------------------- | ---------- | ------------------------------------- |
| `_markets` | `ElectricityMarket[]` | `private`  | `ElectricityMarket`コントラクトの配列 |

Functions

| function                                                           | return | visibility           | description    |
| ------------------------------------------------------------------ | ------ | -------------------- | -------------- |
| `constructor()`                                                    | `void` | `public`             | コンストラクタ |
| `openNewMarket(address owner, string memory name, uint bidPeriod)` | `void` | `external onlyOwner` | 市場を開く     |

## `Ownable.sol`（OpenZeppelin）

コントラクトの所有者を管理する

State Variables

| variable | type      | type visibility | description      |
| -------- | --------- | --------------- | ---------------- |
| `_owner` | `address` | `private`       | 所有者のアドレス |

Modifiers

| modifier      | description              |
| ------------- | ------------------------ |
| `onlyOwner()` | 現在の所有者のみ実行可能 |

Functions

| function                               | return    | visibility         | description      |
| -------------------------------------- | --------- | ------------------ | ---------------- |
| `constructor()`                        | `void`    | `internal`         | コンストラクタ   |
| `owner()`                              | `address` | `public view`      | 現在の所有者     |
| `isOwner()`                            | `bool`    | `public view`      | 自身は所有者か   |
| `renounceOwnership()`                  | `void`    | `public onlyOwner` | 所有権を放棄する |
| `transferOwnership(address newOwner)`  | `void`    | `public onlyOwner` | 所有権を移行する |
| `_transferOwnership(address newOwner)` | `void`    | `internal`         | 所有権を移行する |

Events

| event                                                                           | description                  |
| ------------------------------------------------------------------------------- | ---------------------------- |
| `OwnershipTransferred(address indexed previousOwner, address indexed newOwner)` | 所有権が移行した時発火される |
