# 余剰電力市場コントラクトの開発

## トークン（MyEnergy.sol）

- 余剰電力をトークンとして扱う
- ~~市場は一定時間ごとに開かれるが、各市場の電力は互いに代替不可能なので、代表的な**代替不可能トークン（NFT：Non-Fungible Token）** である「**ERC 721**」を用いる~~
  - NFT は分割不可能であるため、FT を用いる
- トークンの実装には「**OpenZeppelin**」を用いる
- 標準の「~~ERC 721~~ ERC20」には、**Mint**（生成）・ **Burn**（消滅）機能は無いため拡張する

> [中部電力と Keychain、独自のトークン発行・取引基盤の実証実験を完了 ～すべての取引を暗号化し当事者以外から秘匿する分散台帳 - 仮想通貨 Watch](https://crypto.watch.impress.co.jp/docs/news/1193494.html)

| method        | description   | accessibility |
| ------------- | ------------- | ------------- |
| constructor() | Minter の登録 | public        |

```js
pragma solidity 0.5.10;

import "../node_modules/@openzeppelin/contracts/token/ERC721/ERC721.sol";
import "../node_modules/@openzeppelin/contracts/token/ERC721/ERC721Mintable.sol";
import "../node_modules/@openzeppelin/contracts/token/ERC721/ERC721Burnable.sol";

contract MyEnergy is ERC721, ERC721Mintable, ERC721Burnable {
  constructor() ERC721() ERC721Mintable() ERC721Burnable() public {
  }
}
```

## コントラクト（PowerMarket.sol）

- Provable（Oraclilze）のために Provable の「**provableAPI.sol**」をインポートし、「**usingProvable**」コントラクトを継承する
- アクセス制御のために OpenZeppelin の「**Ownable.sol**」をインポートし、「**Ownable**」コントラクトを継承する
- 余剰電力トークンを利用するために、自作の「**MyEnergy.sol**」をインポートし、インスタンス化する。

### 修飾子

#### Role

- Owner：コントラクト所有者
- Minter：トークン生成者
- Burner：トークン消滅者

### 関数

| method                                                     | return | description                           | accessibility     |
| ---------------------------------------------------------- | ------ | ------------------------------------- | ----------------- |
| `constructor()`                                            | void   | デプロイヤー Owner・Minter として登録 | public            |
| `registryUser(address user)`                               | void   | ユーザのアドレスの登録                | public(onlyOwner) |
| `distToken(address user)`                                  | void   | 余剰電力トークンの配布                | public(onlyOwner) |
| `orderBuy(uint price, uint amount)`                        | void   | 買い注文                              | public            |
| `orderSell(uint price, uint amount)`                       | void   | 売り注文                              | public            |
| `startContract()`                                          | void   | 約定の開始。注文期間の終了            | public(onlyOwner) |
| `_exchangeToken()`                                         | void   | トークンと通貨の交換                  | private           |
| `withdraw()`                                               | void   | 利益の引き出し                        | public(onlyOwner) |
| `__callback(bytes32, string memory _result, bytes memory)` | void   | オラクルのコールバック関数            | public            |

```js
pragma solidity 0.5.10;

import "../node_modules/@openzeppelin/contracts/ownership/Ownable.sol";
import "./provableAPI.sol";

contract PowerMarket is usingProvable, Ownable {
}
```

## ユースケース

### サービス提供者

- 市場の開始
  - 終了時間
- ｀｀｀｀｀｀

### 市場参加者

- 買い入札
  - 入札価格
  - 入札量
  - 自身のアドレス
- 売り入札
  - 入札価格
  - 入札量
  - 自身のアドレス
